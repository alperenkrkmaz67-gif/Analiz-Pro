<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Paneli - Oran Analiz</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @media (max-width: 900px) {
            main>div {
                grid-template-columns: 1fr !important;
            }

            main>div>div:first-child {
                flex-direction: row !important;
                flex-wrap: wrap;
            }

            main>div>div:first-child>.glass-card {
                flex: 1;
                min-width: 200px;
            }
        }
    </style>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1971400872681266"
        crossorigin="anonymous"></script>
</head>

<body>
    <header>
    <div class="container">
        <nav style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0;">
            <!-- Back Button -->
            <a href="index.html" class="btn btn-outline" style="padding: 0.5rem 1rem; display: flex; align-items: center; gap: 0.5rem;">
                ‚Üê Ana Sayfa
            </a>
            
            <!-- Logo -->
            <a href="index.html" class="logo" style="font-size: 1.3rem; font-weight: 800; background: linear-gradient(to right, var(--primary-color), var(--accent-color)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
                Analiz Pro
            </a>
        </nav>
    </div>
</header>

    <script>
        function toggleMenu() {
            document.querySelector('nav').classList.toggle('nav-active');
            const isMobile = window.innerWidth <= 768;
            if (isMobile) {
                document.querySelectorAll('.mobile-only-link').forEach(el => el.style.display = 'block');
                document.querySelectorAll('.mobile-only-header').forEach(el => el.style.display = 'block');
            }
        }
    </script>

    <main class="container" style="padding-top: 2rem; max-width: 98%;">
        <h1 style="margin-bottom: 2rem;">Y√∂netim Paneli</h1>

        <div style="display: grid; grid-template-columns: 240px 1fr; gap: 1.5rem; align-items: start; width: 100%;">
            <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                <div class="glass-card">
                    <h3>Kullanƒ±cƒ± ƒ∞statistikleri</h3>
                    <p style="margin-top: 1rem; font-size: 2rem; font-weight: 700; color: var(--primary-color);">
                        <span id="user-count">0</span>
                    </p>
                    <p style="color: var(--secondary-color);">Toplam Kayƒ±tlƒ± Kullanƒ±cƒ±</p>
                </div>
                <div class="glass-card">
                    <h3>Aktif VIP √úyeler</h3>
                    <p style="margin-top: 1rem; font-size: 2rem; font-weight: 700; color: #f59e0b;">
                        <span id="vip-count">0</span>
                    </p>
                    <p style="color: var(--secondary-color);">≈ûu An Aktif Olanlar</p>
                </div>
                <!-- Ziyaret√ßi ƒ∞statistikleri -->
                <div class="glass-card">
                    <h3>Toplam Ziyaret√ßi</h3>
                    <p style="margin-top: 1rem; font-size: 2rem; font-weight: 700; color: #10b981;">
                        <span id="total-visitor-count">0</span>
                    </p>
                    <p style="color: var(--secondary-color);">Bug√ºne Kadar (Tekil)</p>
                </div>
                <div class="glass-card">
                    <h3>Bug√ºnk√º Ziyaret√ßi</h3>
                    <p style="margin-top: 1rem; font-size: 2rem; font-weight: 700; color: #3b82f6;">
                        <span id="today-visitor-count">0</span>
                    </p>
                    <p style="color: var(--secondary-color);">G√ºn√ºn Toplamƒ±</p>
                </div>
            </div>

            <div style="display: flex; flex-direction: column; gap: 2rem; width: 100%;">
                <div class="glass-card">
                    <h3 style="margin-bottom: 1.5rem;">Kullanƒ±cƒ± Y√∂netimi</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; text-align: left;">
                            <thead>
                                <tr style="border-bottom: 1px solid var(--glass-border);">
                                    <th style="padding: 0.75rem;">ƒ∞≈ülemler</th>
                                    <th style="padding: 0.75rem;">VIP Ayarƒ±</th>
                                    <th style="padding: 0.75rem;">Yetki</th>
                                    <th style="padding: 0.75rem;">√úye Profili</th>
                                    <th style="padding: 0.75rem;">E-posta</th>
                                    <th style="padding: 0.75rem;">
                                        <div style="display: flex; align-items: center; gap: 5px; cursor: pointer;"
                                            onclick="toggleDateFilter()">
                                            Kayƒ±t Tarihi <span id="filter-icon">üîç</span>
                                        </div>
                                        <div id="date-filter-container"
                                            style="display: none; margin-top: 5px; align-items: center; gap: 5px;">
                                            <input type="date" id="date-filter-input"
                                                style="padding: 0.3rem; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 4px; color: white; width: 110px; font-family: 'Inter', sans-serif;"
                                                onchange="filterUsersByDate(this.value)"
                                                onclick="event.stopPropagation()">
                                            <button onclick="clearDateFilter(event)"
                                                style="background: none; border: none; color: var(--error-color); cursor: pointer; font-size: 1.2rem;">&times;</button>
                                        </div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="user-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="ip-modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;">
        <div class="glass-card" style="width: 90%; max-width: 500px; padding: 2rem; position: relative;">
            <button id="close-ip-modal"
                style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer;">&times;</button>
            <h3 id="ip-modal-title"
                style="margin-bottom: 1.5rem; border-bottom: 1px solid var(--glass-border); padding-bottom: 1rem;">IP
                Ge√ßmi≈üi</h3>
            <div id="ip-modal-body" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCQ4ACkLfcLIgljpJvwWpy2hF7RaalR7ZI",
            authDomain: "orananaliz.firebaseapp.com",
            projectId: "orananaliz",
            storageBucket: "orananaliz.firebasestorage.app",
            messagingSenderId: "1036870580660",
            appId: "1:1036870580660:web:4c74e00ec6f0483fe39ae1",
            measurementId: "G-D4BMSDR1JS"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
    </script>

    <script src="auth.js"></script>

    <script>
        let allUsersCache = [];

        // === STATS ===
        async function loadStats() {
            try {
                // Global Total
                const globalStats = await db.collection('stats').doc('global').get();
                if (globalStats.exists) {
                    const total = globalStats.data().total_visitors || 0;
                    document.getElementById('total-visitor-count').textContent = total;
                }

                // Daily Stats
                const today = new Date().toISOString().split('T')[0];
                const dailyStats = await db.collection('daily_stats').doc(today).get();
                if (dailyStats.exists) {
                    const count = dailyStats.data().count || 0;
                    document.getElementById('today-visitor-count').textContent = count;
                }
            } catch (error) {
                console.error('ƒ∞statistikler y√ºklenemedi:', error);
            }
        }

        async function loadUsers() {
            try {
                const usersSnapshot = await db.collection('users').orderBy('createdAt', 'desc').get();
                allUsersCache = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Sort: Current user ALWAYS first, others by date desc (already from query)
                const currentUserEmail = auth.currentUser ? auth.currentUser.email : null;
                if (currentUserEmail) {
                    const meIndex = allUsersCache.findIndex(u => u.email === currentUserEmail);
                    if (meIndex > -1) {
                        const me = allUsersCache.splice(meIndex, 1)[0];
                        allUsersCache.unshift(me);
                    }
                }

                document.getElementById('user-count').textContent = allUsersCache.length;

                // Count Active VIPs
                const activeVIPs = allUsersCache.filter(u => u.vipExpiry && new Date(u.vipExpiry) > new Date()).length;
                const vipCountEl = document.getElementById('vip-count');
                if (vipCountEl) vipCountEl.textContent = activeVIPs;

                renderUsers(allUsersCache);

            } catch (error) {
                console.error('Kullanƒ±cƒ±lar y√ºklenemedi:', error);
                // Fallback attempt without orderBy if index is missing (common Firebase issue)
                try {
                    const usersSnapshot = await db.collection('users').get();
                    allUsersCache = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Sort client side
                    allUsersCache.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));

                    // Sort: Current user ALWAYS first
                    const currentUserEmail = auth.currentUser ? auth.currentUser.email : null;
                    if (currentUserEmail) {
                        const meIndex = allUsersCache.findIndex(u => u.email === currentUserEmail);
                        if (meIndex > -1) {
                            const me = allUsersCache.splice(meIndex, 1)[0];
                            allUsersCache.unshift(me);
                        }
                    }

                    document.getElementById('user-count').textContent = allUsersCache.length;
                    renderUsers(allUsersCache);
                } catch (err2) {
                    console.error('Retry failed:', err2);
                    alert('Kullanƒ±cƒ±lar y√ºklenirken hata olu≈ütu!');
                }
            }
        }

        function renderUsers(users) {
            const tbody = document.getElementById('user-table-body');
            tbody.innerHTML = users.map(user => {
                const vipExpiry = user.vipExpiry ? new Date(user.vipExpiry).toLocaleDateString('tr-TR') : '-';
                const createdAt = user.createdAt ? new Date(user.createdAt).toLocaleDateString('tr-TR') : '-';
                const isVIP = user.vipExpiry && new Date(user.vipExpiry) > new Date();

                // Time Left Calculation
                let timeText = '';
                if (isVIP) {
                    const daysLeft = Math.ceil((new Date(user.vipExpiry) - new Date()) / (1000 * 60 * 60 * 24));
                    timeText = `<div style="font-size:0.75rem; color:${daysLeft < 3 ? '#ef4444' : '#f59e0b'}; margin-top:4px;">(${daysLeft} g√ºn kaldƒ±)</div>`;
                }

                // Role Colors
                const roleColors = { 'admin': '#ef4444', 'moderator': '#3b82f6', 'user': '#1e293b' };
                const roleColor = roleColors[user.role] || roleColors['user'];

                return `<tr style="border-bottom: 1px solid var(--glass-border);">
                    <td style="padding: 0.75rem;">
                        <button onclick="showIPHistory('${user.id}', '${user.username}')" class="btn btn-outline" style="padding: 0.4rem 0.8rem; font-size: 0.8rem; margin-right: 0.5rem;">IP</button>
                        <button onclick="deleteUser('${user.id}')" class="btn btn-outline" style="padding: 0.4rem 0.8rem; font-size: 0.8rem; border-color: var(--error-color); color: var(--error-color);">Sil</button>
                    </td>
                    <td style="padding: 0.75rem;">
                        <div style="display:flex; align-items:center; gap: 5px; margin-bottom: 5px;">
                            <button onclick="addVIP('${user.id}', 30)" class="btn btn-outline" style="padding: 2px 6px; font-size: 0.7rem; border-color: #f59e0b; color: #f59e0b;" title="1 Ay Ekle">+1AY</button>
                            <button onclick="addVIP('${user.id}', 90)" class="btn btn-outline" style="padding: 2px 6px; font-size: 0.7rem; border-color: #f59e0b; color: #f59e0b;" title="3 Ay Ekle">+3AY</button>
                            <button onclick="addVIP('${user.id}', 365)" class="btn btn-outline" style="padding: 2px 6px; font-size: 0.7rem; border-color: #f59e0b; color: #f59e0b;" title="1 Yƒ±l Ekle">+1YIL</button>
                        </div>
                        <div style="display:flex; align-items:center;">
                            <input type="date" id="vip-date-${user.id}" value="${user.vipExpiry ? new Date(user.vipExpiry).toISOString().split('T')[0] : ''}" style="padding: 0.3rem; background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 4px; color: white; width: 110px;">
                            <button onclick="updateVIP('${user.id}')" class="btn btn-primary" style="padding: 0.3rem 0.6rem; font-size: 0.75rem; margin-left:5px;">‚úì</button>
                            <button onclick="revokeVIP('${user.id}')" class="btn btn-outline" style="padding: 0.3rem 0.6rem; font-size: 0.75rem; margin-left:5px; border-color:#ef4444; color:#ef4444;" title="VIP ƒ∞ptal">X</button>
                        </div>
                        ${timeText}
                    </td>
                    <td style="padding: 0.75rem;">
                        <select onchange="changeRole('${user.id}', this.value)" style="background: ${roleColor}; color: white; border: 1px solid rgba(255, 255, 255, 0.1); padding: 0.3rem; border-radius: 4px; font-size: 0.8rem; font-weight: 600;">
                            <option value="user" ${(!user.role || user.role === 'user') ? 'selected' : ''}>√úye</option>
                            <option value="moderator" ${user.role === 'moderator' ? 'selected' : ''}>Moderat√∂r</option>
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Y√∂netici</option>
                        </select>
                    </td>
                    <td style="padding: 0.75rem;">
                        <div style="display:flex; flex-direction:column;">
                            <span style="font-weight:600; color:white;">${user.username || '-'}</span>
                            ${isVIP
                        ? '<span style="font-size:0.7rem; background:rgba(245, 158, 11, 0.2); color:#fbbf24; border:1px solid rgba(245, 158, 11, 0.4); padding:2px 6px; border-radius:4px; width:fit-content; margin-top:4px;">üíé VIP √úYE</span>'
                        : '<span style="font-size:0.7rem; background:rgba(148, 163, 184, 0.1); color:#94a3b8; border:1px solid rgba(148, 163, 184, 0.2); padding:2px 6px; border-radius:4px; width:fit-content; margin-top:4px;">üë§ STANDART</span>'}
                        </div>
                    </td>
                    <td style="padding: 0.75rem;">${user.email || '-'}</td>
                    <td style="padding: 0.75rem;">${createdAt}</td>
                </tr>`;
            }).join('');
        }

        function toggleDateFilter() {
            const container = document.getElementById('date-filter-container');
            const isVisible = container.style.display === 'flex';
            container.style.display = isVisible ? 'none' : 'flex';
        }

        function filterUsersByDate(dateVal) {

            // Start with all users
            let filtered = [...allUsersCache];

            if (dateVal) {
                filtered = filtered.filter(user => {
                    if (!user.createdAt) return false;
                    // Convert to Local YYYY-MM-DD to match the table display which uses local time
                    const d = new Date(user.createdAt);
                    const regDate = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
                    return regDate === dateVal;
                });
            }

            // Ensure Current User is ALWAYS at the top, even if filtered out
            const currentUserEmail = auth.currentUser ? auth.currentUser.email : null;
            if (currentUserEmail) {
                // Remove existing instance of "Me" from filtered list to prevent duplicates
                filtered = filtered.filter(u => u.email !== currentUserEmail);

                // Find "Me" in the global cache
                const me = allUsersCache.find(u => u.email === currentUserEmail);
                if (me) {
                    filtered.unshift(me);
                }
            }

            renderUsers(filtered);
        }

        function clearDateFilter(e) {
            e.stopPropagation();
            const input = document.getElementById('date-filter-input');
            input.value = '';
            renderUsers(allUsersCache);
            document.getElementById('date-filter-container').style.display = 'none';
        }

        async function showIPHistory(userId, username) {
            const user = allUsersCache.find(u => u.id === userId);
            if (!user) return;

            const modal = document.getElementById('ip-modal');
            const title = document.getElementById('ip-modal-title');
            const body = document.getElementById('ip-modal-body');

            title.textContent = `${username} - IP Ge√ßmi≈üi`;

            if (user.ipHistory && user.ipHistory.length > 0) {
                body.innerHTML = user.ipHistory.map(entry => {
                    const date = new Date(entry.timestamp).toLocaleString('tr-TR');
                    return `<div style="padding: 0.75rem; border-bottom: 1px solid var(--glass-border);">
                        <strong>${entry.ip}</strong> - ${date}
                    </div>`;
                }).join('');
            } else {
                body.innerHTML = '<p style="text-align: center; padding: 2rem; color: var(--secondary-color);">IP ge√ßmi≈üi bulunamadƒ±.</p>';
            }

            modal.style.display = 'flex';
        }
        window.showIPHistory = showIPHistory;

        async function addVIP(userId, days) {
            const user = allUsersCache.find(u => u.id === userId);
            let startDate = new Date();
            // Eger suresi bitmemis VIP ise, bitis tarihinden ekle
            if (user && user.vipExpiry && new Date(user.vipExpiry) > new Date()) {
                startDate = new Date(user.vipExpiry);
            }

            const newExpiry = new Date(startDate);
            newExpiry.setDate(newExpiry.getDate() + days);

            try {
                const updateData = { vipExpiry: newExpiry.toISOString() };
                // Eger rolu admin veya moderator degilse, otomatik VIP yap
                if (!user.role || user.role === 'user') {
                    updateData.role = 'vip';
                }

                await db.collection('users').doc(userId).update(updateData);
                alert(`${days} g√ºn VIP eklendi!`);
                loadUsers();
            } catch (error) {
                console.error('VIP eklenemedi:', error);
                alert('VIP eklenirken hata olu≈ütu!');
            }
        }
        window.addVIP = addVIP;

        async function updateVIP(userId) {
            const dateInput = document.getElementById(`vip-date-${userId}`);
            const newDate = dateInput.value;

            if (!newDate) {
                alert('L√ºtfen bir tarih se√ßin!');
                return;
            }

            try {
                await db.collection('users').doc(userId).update({
                    vipExpiry: new Date(newDate).toISOString()
                });
                alert('VIP s√ºresi g√ºncellendi!');
                loadUsers();
            } catch (error) {
                console.error('VIP g√ºncellenemedi:', error);
                alert('VIP g√ºncellenirken hata olu≈ütu!');
            }
        }
        window.updateVIP = updateVIP;

        async function revokeVIP(userId) {
            if (!confirm('VIP √ºyeliƒüi iptal edilsin mi?')) return;
            try {
                await db.collection('users').doc(userId).update({
                    vipExpiry: null,
                    role: 'user'
                });
                // alert('VIP iptal edildi.'); // Optional: reduce popup spam
                loadUsers();
            } catch (error) {
                console.error('Hata:', error);
                alert('ƒ∞≈ülem ba≈üarƒ±sƒ±z!');
            }
        }
        window.revokeVIP = revokeVIP;

        async function changeRole(userId, newRole) {
            // Confirm dialog for Admin role change to prevent accidents
            if (newRole === 'admin' && !confirm('Bu kullanƒ±cƒ±ya Y√ñNETƒ∞Cƒ∞ yetkisi vermek istediƒüinize emin misiniz?')) {
                loadUsers(); // Reset visuals
                return;
            }

            try {
                await db.collection('users').doc(userId).update({
                    role: newRole
                });
                alert(`Rol g√ºncellendi: ${newRole.toUpperCase()}`);
                loadUsers();
            } catch (error) {
                console.error('Hata:', error);
                alert('Rol g√ºncelleme ba≈üarƒ±sƒ±z!');
                loadUsers();
            }
        }
        window.changeRole = changeRole;

        async function deleteUser(userId) {
            if (!confirm('Bu kullanƒ±cƒ±yƒ± silmek istediƒüinizden emin misiniz?')) return;

            try {
                await db.collection('users').doc(userId).delete();
                alert('Kullanƒ±cƒ± silindi!');
                loadUsers();
            } catch (error) {
                console.error('Kullanƒ±cƒ± silinemedi:', error);
                alert('Kullanƒ±cƒ± silinirken hata olu≈ütu!');
            }
        }
        window.deleteUser = deleteUser;

        document.getElementById('close-ip-modal').onclick = () => {
            document.getElementById('ip-modal').style.display = 'none';
        };

        // Ba≈ülangƒ±√ß
        auth.onAuthStateChanged(user => {
            if (user) {

                loadUsers();
                loadStats();
            } else {
                window.location.href = 'login.html';
            }
        });

    </script>
</body>

</html>